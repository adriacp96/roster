<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RosterCal</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üóìÔ∏è</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --emirates-red: #d71921;
            --emirates-gold: #c4a647;
            --dark-grey: #333333;
            --light-grey: #f4f5f7;
            --white: #ffffff;
            --green: #28a745;
            --font-main: 'Montserrat', sans-serif;
            --color-background: var(--light-grey);
            --color-surface: var(--white);
            --color-text-primary: var(--dark-grey);
            --color-text-secondary: #6c757d;
            --color-border: #e0e0e0;
            --color-header-bg: var(--dark-grey);
            --color-header-text: var(--white);
            --color-header-span: #cccccc;
            --color-details-bg: #fafafa;
            --color-summary-action: var(--emirates-red);
            color-scheme: light dark;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #121212;
                --color-surface: #1e1e1e;
                --color-text-primary: #e1e1e1;
                --color-text-secondary: #888888;
                --color-header-bg: #1e1e1e;
                --color-header-text: #e1e1e1;
                --color-header-span: #888888;
                --color-border: #3a3a3a;
                --color-details-bg: #2c2c2c;
                --color-summary-action: var(--emirates-gold);
            }
        }
        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 40px 20px;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: var(--color-surface);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
            margin: 0 auto;
            transition: background-color 0.3s;
        }
        .header {
            padding: 25px 30px;
            background-color: var(--color-header-bg);
            text-align: center;
            transition: background-color 0.3s;
        }
        .header h1 {
            font-size: 2.2rem; font-weight: 700; margin: 0; color: var(--color-header-text);
        }
        .header h1 span {
            font-weight: 300; color: var(--color-header-span);
        }
        .main-content {
            padding: 30px;
            text-align: center;
        }
        .step h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 20px;
        }
        .step .instructions, .step li {
            font-size: 1rem;
            color: var(--color-text-secondary);
            text-align: left;
            line-height: 1.6;
        }
        .step .instructions a {
            color: var(--emirates-red);
            font-weight: bold;
            text-decoration: none;
        }
        .step .instructions a:hover {
            text-decoration: underline;
        }
        details {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 40px;
            background-color: var(--color-details-bg);
            text-align: left;
            transition: background-color 0.3s, border-color 0.3s;
        }
        summary {
            cursor: pointer;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        summary::-webkit-details-marker { display: none; }
        summary::after {
            content: 'Show ‚ñº';
            font-size: 0.9rem;
            color: var(--color-summary-action);
            font-weight: bold;
        }
        details[open] summary::after { content: 'Hide ‚ñ≤'; }
        .details-content {
            padding: 0 15px 15px 15px;
            border-top: 1px solid var(--color-border);
            transition: border-color 0.3s;
        }
        .bookmarklet-link {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--emirates-red);
            color: #ffffff;
            border-radius: 8px;
            font-weight: bold;
            text-decoration: none;
            cursor: move;
            margin-top: 10px;
        }
        .magic-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: var(--emirates-red);
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .magic-button:hover { transform: scale(1.1); }
        .magic-button .icon { font-size: 2.5rem; line-height: 1; transition: transform 0.3s ease-in-out; }
        .magic-button.success { background-color: var(--green); }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <h1><span>Roster</span>Cal</h1>
        </header>
        <main class="main-content">
            <details>
                <summary>Bookmarklet Setup</summary>
                <div class="details-content">
                    <p class="instructions" style="margin-top: 15px;">To easily copy your roster (especially on iPhone), set up this bookmarklet once.</p>
                    <ol>
                        <li>Press and hold the link below: <br>
                            <a href="#" id="bookmarklet-link" class="bookmarklet-link">Copy Roster</a>
                        </li>
                        <li>Drag it to your Bookmarks Bar or Favorites.</li>
                    </ol>
                </div>
            </details>
            <div class="step">
                <h2>Process Your Roster</h2>
                <p class="instructions" style="text-align: center; margin-bottom: 25px;">
                    Go to your roster <a href="https://emiratesgroup.sharepoint.com/sites/ccp/roster/Pages/Roster.aspx" target="_blank" rel="noopener noreferrer">page</a>, click the "Copy Roster" bookmark, then come back and click the button below.
                </p>
                <a href="#" id="magic-button" class="magic-button">
                    <span id="button-icon" class="icon">üìã</span>
                </a>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bookmarkletLink = document.getElementById('bookmarklet-link');
            const magicButton = document.getElementById('magic-button');
            const buttonIcon = document.getElementById('button-icon');
            let isProcessed = false;
           
            const bookmarkletCode = `javascript:(function(){try{navigator.clipboard.writeText(document.body.innerText);alert('Roster text copied!\\n\\nNow go back to the RosterCal page and click the main button.');}catch(e){alert('Error: Could not copy text. Please try copying manually.');}})();`;
            bookmarkletLink.href = bookmarkletCode;

            magicButton.addEventListener('click', (event) => {
                if (isProcessed) { return; }
                event.preventDefault();

                navigator.clipboard.readText().then(text => {
                    if (!text) {
                        alert("Clipboard is empty. Please use the 'Copy Roster' bookmarklet first.");
                        return;
                    }
                   
                    const events = parsePlainTextForRosterEvents(text);
                    if (!events || events.length === 0) {
                        buttonIcon.innerText = '‚ùå';
                        setTimeout(() => { buttonIcon.innerText = 'üìã'; }, 2000);
                        return;
                    }
                   
                    const icsContent = generateIcsFile(events);
                    const file = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                    const url = URL.createObjectURL(file);
                   
                    buttonIcon.innerText = '‚úîÔ∏è';
                    magicButton.classList.add('success');
                    isProcessed = true;
                    magicButton.href = url;
                    magicButton.setAttribute('download', 'MyRoster.ics');

                    setTimeout(() => {
                        buttonIcon.style.transform = 'rotate(360deg)';
                        buttonIcon.innerText = '‚¨áÔ∏è';
                    }, 1000); 
                   
                }).catch(err => {
                    alert('Could not read clipboard. Please allow permission and try again.');
                    buttonIcon.innerText = '‚ùå';
                    setTimeout(() => { buttonIcon.innerText = 'üìã'; }, 2000);
                });
            });
        });

        const timeZoneOffsets = { 'ABJ': 0, 'ABV': 1, 'ACC': 0, 'ADD': 3, 'ADL': 9.5, 'AKL': 12, 'ALG': 1, 'AMD': 5.5, 'AMM': 3, 'AMS': 2, 'ARN': 2, 'ATH': 3, 'ATL': -4, 'BAH': 3, 'BBI': 5.5, 'BCN': 2, 'BEY': 3, 'BGI': -4, 'BGW': 3, 'BHX': 1, 'BKK': 7, 'BLQ': 2, 'BLR': 5.5, 'BNE': 10, 'BOG': -5, 'BOM': 5.5, 'BOS': -4, 'BRU': 2, 'BSB': -3, 'BSR': 3, 'BUD': 2, 'CAI': 3, 'CAN': 8, 'CCJ': 5.5, 'CCU': 5.5, 'CDG': 2, 'CEB': 8, 'CGK': 7, 'CHC': 12, 'CKY': 0, 'CMB': 5.5, 'CMN': 1, 'COK': 5.5, 'CPH': 2, 'CPT': 2, 'CRK': 8, 'DAC': 6, 'DAR': 3, 'DEL': 5.5, 'DEN': -6, 'DFW': -5, 'DJE': 1, 'DME': 3, 'DMM': 3, 'DOH': 3, 'DPS': 8, 'DSS': 0, 'DUB': 1, 'DUR': 2, 'DUS': 2, 'DXB': 4, 'EBB': 3, 'EDI': 1, 'EWR': -4, 'EZE': -3, 'FCO': 2, 'FRA': 2, 'GIG': -3, 'GLA': 1, 'GOT': 2, 'GRU': -3, 'GVA': 2, 'GYD': 4, 'HAM': 2, 'HAN': 7, 'HBE': 3, 'HEL': 3, 'HGH': 8, 'HKG': 8, 'HKT': 7, 'HND': 9, 'HRE': 2, 'HYD': 5.5, 'IAD': -4, 'IAH': -5, 'ICN': 9, 'IKA': 3.5, 'ISB': 5, 'IST': 3, 'JED': 3, 'JFK': -4, 'JNB': 2, 'KHI': 5, 'KIX': 9, 'KRT': 2, 'KUL': 8, 'KWI': 3, 'LAD': 1, 'LAX': -7, 'LCA': 3, 'LED': 3, 'LGW': 1, 'LHE': 5, 'LHR': 1, 'LIS': 1, 'LOS': 1, 'LUN': 2, 'LYS': 2, 'MAA': 5.5, 'MAD': 2, 'MAN': 1, 'MCO': -4, 'MCT': 4, 'MED': 3, 'MEL': 10, 'MEX': -6, 'MIA': -4, 'MLA': 2, 'MLE': 5, 'MNL': 8, 'MPM': 2, 'MRU': 4, 'MUC': 2, 'MXP': 2, 'NBO': 3, 'NCE': 2, 'NCL': 1, 'NDJ': 1, 'NRT': 9, 'ORD': -5, 'OSL': 2, 'OTP': 3, 'PER': 8, 'PEW': 5, 'PNH': 7, 'PRG': 2, 'PVG': 8, 'RUH': 3, 'SAW': 3, 'SEA': -7, 'SEZ': 4, 'SFO': -7, 'SGN': 7, 'SIN': 8, 'SKT': 5, 'STN': 1, 'SZX': 8, 'SYD': 10, 'TNR': 3, 'TPE': 8, 'TLV': 3, 'TRV': 5.5, 'TUN': 1, 'VCE': 2, 'VIE': 2, 'WAW': 2, 'YYC': -6, 'YUL': -4, 'YYZ': -4, 'ZAG': 2, 'ZRH': 2 };
        const airportNames = { 'ABJ': 'Abidjan', 'ABV': 'Abuja', 'ACC': 'Accra', 'ADD': 'Addis Ababa', 'ADL': 'Adelaide', 'AKL': 'Auckland', 'ALG': 'Algiers', 'AMD': 'Ahmedabad', 'AMM': 'Amman', 'AMS': 'Amsterdam', 'ARN': 'Stockholm', 'ATH': 'Athens', 'ATL': 'Atlanta', 'BAH': 'Bahrain', 'BBI': 'Bhubaneswar', 'BCN': 'Barcelona', 'BEY': 'Beirut', 'BGW': 'Baghdad', 'BHX': 'Birmingham', 'BKK': 'Bangkok', 'BLQ': 'Bologna', 'BLR': 'Bengaluru', 'BNE': 'Brisbane', 'BOG': 'Bogota', 'BOM': 'Mumbai', 'BOS': 'Boston', 'BRU': 'Brussels', 'BSR': 'Basra', 'BUD': 'Budapest', 'CAI': 'Cairo', 'CAN': 'Guangzhou', 'CCJ': 'Kozhikode', 'CCU': 'Kolkata', 'CDG': 'Paris', 'CEB': 'Cebu', 'CGK': 'Jakarta', 'CHC': 'Christchurch', 'CKY': 'Conakry', 'CMB': 'Colombo', 'CMN': 'Casablanca', 'COK': 'Kochi', 'CPH': 'Copenhagen', 'CPT': 'Cape Town', 'CRK': 'Clark', 'DAC': 'Dhaka', 'DAR': 'Dar es Salaam', 'DEL': 'Delhi', 'DEN': 'Denver', 'DFW': 'Dallas', 'DJE': 'Djerba', 'DME': 'Moscow', 'DMM': 'Dammam', 'DOH': 'Doha', 'DPS': 'Denpasar', 'DSS': 'Dakar', 'DUB': 'Dublin', 'DUR': 'Durban', 'DUS': 'Dusseldorf', 'DXB': 'Dubai', 'EBB': 'Entebbe', 'EDI': 'Edinburgh', 'EWR': 'Newark', 'EZE': 'Buenos Aires', 'FCO': 'Rome', 'FRA': 'Frankfurt', 'GIG': 'Rio de Janeiro', 'GLA': 'Glasgow', 'GOT': 'Gothenburg', 'GRU': 'Sao Paulo', 'GVA': 'Geneva', 'GYD': 'Baku', 'HAM': 'Hamburg', 'HAN': 'Hanoi', 'HBE': 'Alexandria', 'HEL': 'Helsinki', 'HGH': 'Hangzhou', 'HKG': 'Hong Kong', 'HKT': 'Phuket', 'HND': 'Tokyo-Haneda', 'HRE': 'Harare', 'HYD': 'Hyderabad', 'IAD': 'Washington D.C.', 'IAH': 'Houston', 'ICN': 'Seoul', 'IKA': 'Tehran', 'ISB': 'Islamabad', 'IST': 'Istanbul', 'JED': 'Jeddah', 'JFK': 'New York', 'JNB': 'Johannesburg', 'KHI': 'Karachi', 'KIX': 'Osaka', 'KRT': 'Khartoum', 'KUL': 'Kuala Lumpur', 'KWI': 'Kuwait City', 'LAD': 'Luanda', 'LAX': 'Los Angeles', 'LCA': 'Larnaca', 'LED': 'St. Petersburg', 'LGW': 'London-Gatwick', 'LHE': 'Lahore', 'LHR': 'London-Heathrow', 'LIS': 'Lisbon', 'LOS': 'Lagos', 'LUN': 'Lusaka', 'LYS': 'Lyon', 'MAA': 'Chennai', 'MAD': 'Madrid', 'MAN': 'Manchester', 'MCO': 'Orlando', 'MCT': 'Muscat', 'MED': 'Medina', 'MEL': 'Melbourne', 'MEX': 'Mexico City', 'MIA': 'Miami', 'MLA': 'Malta', 'MLE': 'Mal√©', 'MNL': 'Manila', 'MPM': 'Maputo', 'MRU': 'Mauritius', 'MUC': 'Munich', 'MXP': 'Milan', 'NBO': 'Nairobi', 'NCE': 'Nice', 'NCL': 'Newcastle', 'NRT': 'Tokyo-Narita', 'ORD': 'Chicago', 'OSL': 'Oslo', 'OTP': 'Bucharest', 'PER': 'Perth', 'PEW': 'Peshawar', 'PNH': 'Phnom Penh', 'PRG': 'Prague', 'PVG': 'Shanghai', 'RUH': 'Riyadh', 'SAW': 'Istanbul-Sabiha', 'SEA': 'Seattle', 'SEZ': 'Seychelles', 'SFO': 'San Francisco', 'SGN': 'Ho Chi Minh City', 'SIN': 'Singapore', 'SKT': 'Sialkot', 'STN': 'London-Stansted', 'SZX': 'Shenzhen', 'SYD': 'Sydney', 'TNR': 'Antananarivo', 'TPE': 'Taipei', 'TLV': 'Tel Aviv', 'TRV': 'Thiruvananthapuram', 'TUN': 'Tunis', 'VCE': 'Venice', 'VIE': 'Vienna', 'WAW': 'Warsaw', 'YYC': 'Calgary', 'YUL': 'Montreal', 'YYZ': 'Toronto', 'ZAG': 'Zagreb', 'ZRH': 'Zurich' };
       
        function createEventsFromParsedData(duties, leave) {
            const finalEvents = [];
            leave.forEach(l => finalEvents.push(l));
            const sortedDuties = duties.sort((a, b) => a.reportTime - b.reportTime);
            sortedDuties.forEach((duty, index) => {
                const depName = airportNames[duty.depSt] || duty.depSt;
                const arrName = airportNames[duty.arrSt] || duty.arrSt;
                if (duty.depSt === 'DXB') {
                    finalEvents.push({
                        title: 'üïë REPORT',
                        description: `Report for flight EK${duty.flightNum} to ${arrName} (${duty.arrSt})`,
                        location: duty.depSt,
                        startTime: duty.reportTime,
                        endTime: new Date(duty.reportTime.getTime() + 90 * 60 * 1000)
                    });
                }
                finalEvents.push({
                    title: `‚úàÔ∏è ${depName} (${duty.depSt}) - ${arrName} (${duty.arrSt})`,
                    description: `Flight: EK${duty.flightNum}\\nFrom: ${depName} (${duty.depSt})\\nTo: ${arrName} (${duty.arrSt})\\nDuration: ${duty.durationStr.replace(':', 'h ')}m`,
                    location: `${duty.depSt}-${duty.arrSt}`,
                    startTime: duty.departureTime,
                    endTime: duty.arrivalTime
                });
                const nextDuty = sortedDuties[index + 1];
                if (nextDuty && duty.arrSt === nextDuty.depSt && duty.arrSt !== 'DXB') {
                    const layoverStart = duty.arrivalTime;
                    const trueLayoverEnd = nextDuty.departureTime;
                    if (trueLayoverEnd > layoverStart) {
                        const durationMillis = trueLayoverEnd.getTime() - layoverStart.getTime();
                        const threeHoursInMillis = 3 * 60 * 60 * 1000;
                        if (durationMillis > threeHoursInMillis) {
                            const totalMinutes = Math.round(durationMillis / (1000 * 60));
                            const hours = Math.floor(totalMinutes / 60);
                            const minutes = totalMinutes % 60;
                            const formattedDuration = `${hours}:${String(minutes).padStart(2, '0')}`;
                            finalEvents.push({
                                title: `üíº Layover (${formattedDuration} hours)`,
                                description: `Layover in ${airportNames[duty.arrSt] || duty.arrSt}. Total duration: ${formattedDuration} hours.`,
                                location: duty.arrSt,
                                startTime: layoverStart,
                                endTime: new Date(layoverStart.getTime() + 30 * 60 * 1000)
                            });
                        }
                    }
                }
            });
            return finalEvents;
        }

        // ---------- MODIFIED FUNCTION: Robust XX detection (rest untouched) ----------
        function parsePlainTextForRosterEvents(text) {
            const parsedDuties = [];
            const allDayEvents = new Map();

            // Roster period (date range)
            let dateRangeMatch = text.match(/(\d{1,2})-(\d{1,2})-(\d{4})\s+to\s+(\d{1,2})-(\d{1,2})-(\d{4})/);
            let startRosterDay, endRosterDay, month, year;
            if (dateRangeMatch) {
                startRosterDay = parseInt(dateRangeMatch[1], 10);
                month = parseInt(dateRangeMatch[2], 10);
                year = parseInt(dateRangeMatch[3], 10);
                endRosterDay = parseInt(dateRangeMatch[4], 10);
            } else {
                dateRangeMatch = text.match(/(\d{1,2})-(\d{1,2})-(\d{4})\s+to/);
                if (!dateRangeMatch) {
                    alert("Error: Could not determine the roster's date range.");
                    return [];
                }
                month = parseInt(dateRangeMatch[2], 10);
                year = parseInt(dateRangeMatch[3], 10);
                startRosterDay = 1;
                endRosterDay = new Date(year, month, 0).getDate();
            }
            const createDubaiUTCDate = (day, h, m) => {
                const offset = timeZoneOffsets['DXB'];
                let dt = new Date(Date.UTC(year, month - 1, day, h, m));
                dt.setUTCHours(dt.getUTCHours() - offset);
                return dt;
            };

            // Robust XX/AllDay detection: Find days/code lines anywhere
            const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
            let daysLine = null, codesLine = null;
            for (let i = 0; i < lines.length - 1; ++i) {
                if (/^\d+(\s+\d+)*$/.test(lines[i]) && /^[A-Z0-9]{2,}(\s+[A-Z0-9]{2,})*$/.test(lines[i+1])) {
                    daysLine = lines[i].split(/\s+/).map(Number);
                    codesLine = lines[i+1].split(/\s+/);
                    break;
                }
            }
            if (daysLine && codesLine) {
                for (let i = 0; i < Math.min(daysLine.length, codesLine.length); ++i) {
                    const day = daysLine[i];
                    if (isNaN(day) || day < startRosterDay || day > endRosterDay) continue;
                    const code = codesLine[i].trim();
                    let eventTitle = null, eventDesc = null;
                    if (code.startsWith('XX')) {
                        eventTitle = code === 'XX' ? 'üè† Day Off' : `üè† Day Off (${code})`;
                        eventDesc = code === 'XX' ? 'Day Off' : `Day Off (${code})`;
                    } else if (code === 'LV') {
                        eventTitle = 'üèñÔ∏è Annual Leave'; eventDesc = 'Annual Leave';
                    } else if (code === 'LLV') {
                        eventTitle = 'üèñÔ∏è Live Leave'; eventDesc = 'Live Leave';
                    } else if (code === 'SK') {
                        eventTitle = 'ü§í SICK'; eventDesc = 'SICK';
                    }
                    if (eventTitle) {
                        allDayEvents.set(day, {
                            isAllDay: true,
                            title: eventTitle,
                            description: eventDesc,
                            location: 'Home',
                            startTime: createDubaiUTCDate(day, 0, 1),
                        });
                    }
                }
            }
            // --- original parsing below remains unchanged ---
            const linesOrig = text.split('\n');
            let currentDay = null;
            let lastParentDutyReportTime = null;
            let lastFlightArrivalTime = null;

            for (const line of linesOrig) {
                const flightWithDutyCode = line.match(/^(\d{2})\s+\w{3}\s+([A-Z0-9]+)\s+(\d{2}:\d{2})\s+(\w+)\s+([A-Z]{3})\s+(\d{2}:\d{2})\s+([A-Z]{3})\s+(\d{2}:\d{2})\s+(\d{2}:\d{2})/);
                const flightWithoutDutyCode = line.match(/^(\d{2})\s+\w{3}\s+(\d{2}:\d{2})\s+(\w+)\s+([A-Z]{3})\s+(\d{2}:\d{2})\s+([A-Z]{3})\s+(\d{2}:\d{2})\s+(\d{2}:\d{2})/);
                const secondaryFlightMatch = line.trim().match(/^(\d{2}:\d{2})\s+(\w+)\s+([A-Z]{3})\s+(\d{2}:\d{2})\s+([A-Z]{3})\s+(\d{2}:\d{2})\s+(\d{2}:\d{2})/);
                const leaveMatch = line.match(/^(\d{2})\s+\w{3}\s+([A-Z0-9]+)\s+(\d{2}:\d{2})\s+(.+?)\s+(\d{2}:\d{2})$/);
                let dutyInfo = null;

                if (flightWithDutyCode) {
                    lastFlightArrivalTime = null; 
                    currentDay = parseInt(flightWithDutyCode[1], 10);
                    const [_, _d, type, report, flight, depSt, depTime, arrSt, arrTime, dur] = flightWithDutyCode;
                    dutyInfo = { day: currentDay, reportTimeStr: report, flightNum: flight, depSt, depTimeStr: depTime, arrSt, arrTimeStr: arrTime, durationStr: dur };
                    lastParentDutyReportTime = report;
                } else if (flightWithoutDutyCode) {
                    currentDay = parseInt(flightWithoutDutyCode[1], 10);
                    const [_, _d, report, flight, depSt, depTime, arrSt, arrTime, dur] = flightWithoutDutyCode;
                    dutyInfo = { day: currentDay, reportTimeStr: report, flightNum: flight, depSt, depTimeStr: depTime, arrSt, arrTimeStr: arrTime, durationStr: dur };
                    lastParentDutyReportTime = report;
                } else if (secondaryFlightMatch && currentDay && lastParentDutyReportTime) {
                    const [_, report, flight, depSt, depTime, arrSt, arrTime, dur] = secondaryFlightMatch;
                    if(report === lastParentDutyReportTime) {
                        dutyInfo = { day: currentDay, reportTimeStr: lastParentDutyReportTime, flightNum: flight, depSt: depSt, depTimeStr: depTime, arrSt: arrSt, arrTimeStr: arrTime, durationStr: dur};
                    }
                }
                
                if (dutyInfo) {
                    const localOffset = timeZoneOffsets[dutyInfo.depSt];
                    if (localOffset === undefined) {
                        alert(`Error: Timezone not found for ${dutyInfo.depSt}.`);
                        continue;
                    }
                    
                    const createLocalUTCDate = (day, timeStr) => {
                        const [h, m] = timeStr.split(':').map(Number);
                        let dt = new Date(Date.UTC(year, month - 1, day, h, m));
                        dt.setUTCHours(dt.getUTCHours() - localOffset);
                        return dt;
                    };

                    const [reportH, reportM] = dutyInfo.reportTimeStr.split(':').map(Number);
                    const reportTime = createDubaiUTCDate(dutyInfo.day, reportH, reportM);
                    
                    let departureTime = createLocalUTCDate(dutyInfo.day, dutyInfo.depTimeStr);
                    
                    if (lastFlightArrivalTime) {
                         if (departureTime < lastFlightArrivalTime) {
                            departureTime.setUTCDate(departureTime.getUTCDate() + 1);
                        }
                    } else {
                        if (departureTime < reportTime) {
                            const twelveHoursInMillis = 12 * 60 * 60 * 1000;
                            if ((reportTime - departureTime) > twelveHoursInMillis) {
                                departureTime.setUTCDate(departureTime.getUTCDate() + 1);
                            }
                        }
                    }
                    
                    const [durH, durM] = dutyInfo.durationStr.split(':').map(Number);
                    const durationMillis = (durH * 60 + durM) * 60 * 1000;
                    const arrivalTime = new Date(departureTime.getTime() + durationMillis);
                    lastFlightArrivalTime = arrivalTime;

                    parsedDuties.push({ reportTime, departureTime, arrivalTime, flightNum: dutyInfo.flightNum, depSt: dutyInfo.depSt, arrSt: dutyInfo.arrSt, durationStr: dutyInfo.durationStr });
                } else if (leaveMatch) {
                    lastFlightArrivalTime = null; 
                    const day = parseInt(leaveMatch.slice(1)[0], 10);
                    if (!allDayEvents.has(day)) continue;

                    const [dayStr, type, startTimeStr, desc, endTimeStr] = leaveMatch.slice(1);
                    const descLower = desc.trim().toLowerCase();
                    let isAllDay = !(type.startsWith('C') || descLower.includes('sby'));

                    if (isAllDay) {
                        let title, description;
                        if (descLower.includes('annual leave')) { title = 'üèñÔ∏è Annual Leave'; description = 'Annual Leave'; } 
                        else if (descLower.includes('live leave')) { title = 'üèñÔ∏è Live Leave'; description = 'Live Leave'; } 
                        else if (descLower.includes('day off')) { const reason = descLower.replace('day off', '').trim(); title = `üè† Day Off${reason ? ` (${reason.toUpperCase()})` : ''}`; description = `Day Off${reason ? ` (${reason.toUpperCase()})` : ''}`; }
                        else if (descLower === 'sick') { title = 'ü§í SICK'; description = 'SICK'; }
                        else { title = 'üè† No Scheduled Duty'; description = 'No Scheduled Duty'; }
                        allDayEvents.get(day).title = title;
                        allDayEvents.get(day).description = description;
                    } else {
                        const [startH, startM] = startTimeStr.split(':').map(Number);
                        const [endH, endM] = endTimeStr.split(':').map(Number);
                        const startTime = createDubaiUTCDate(day, startH, startM);
                        let endTimeDate = createDubaiUTCDate(day, endH, endM);
                        if (endTimeDate < startTime) { endTimeDate.setDate(endTimeDate.getDate() + 1); }
                        
                        allDayEvents.set(day, {
                            title: type.startsWith('C') ? `üìñ ${type}` : `üì° ${desc.trim()} (${startTimeStr}-${endTimeStr})`,
                            description: desc.trim(),
                            location: "Home",
                            startTime: startTime,
                            endTime: endTimeDate,
                            isAllDay: false
                        });
                    }
                }
            }
            const flightActivityDays = new Set();
            for (const duty of parsedDuties) {
                flightActivityDays.add(duty.reportTime.getUTCDate());
                flightActivityDays.add(duty.departureTime.getUTCDate());
                flightActivityDays.add(duty.arrivalTime.getUTCDate());
            }

            const finalLeaveEvents = Array.from(allDayEvents.values());
            return createEventsFromParsedData(parsedDuties, finalLeaveEvents);
        }
        // ---------- END MODIFIED FUNCTION ----------

        function generateIcsFile(events) {
            events.sort((a, b) => a.startTime - b.startTime);
            let icsString = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//RosterCal//EN'].join('\r\n') + '\r\n';
            
            events.forEach(event => {
                if (!event.startTime || isNaN(event.startTime)) return;

                const formatFullDate = (dt) => {
                    const year = dt.getUTCFullYear();
                    const month = String(dt.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(dt.getUTCDate()).padStart(2, '0');
                    return `${year}${month}${day}`;
                };

                const formatDateTime = (dt) => {
                    return new Date(dt).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                let dtstart, dtend;

                if (event.isAllDay) {
                    dtstart = `DTSTART;VALUE=DATE:${formatFullDate(event.startTime)}`;
                    const endDate = new Date(event.startTime);
                    endDate.setUTCDate(endDate.getUTCDate() + 1);
                    dtend = `DTEND;VALUE=DATE:${formatFullDate(endDate)}`;
                } else {
                    if (!event.endTime || isNaN(event.endTime)) return;
                    dtstart = `DTSTART:${formatDateTime(event.startTime)}`;
                    dtend = `DTEND:${formatDateTime(event.endTime)}`;
                }

                icsString += [
                    'BEGIN:VEVENT',
                    `UID:${Date.now()}${Math.random()}@rostercal.com`,
                    `DTSTAMP:${formatDateTime(new Date())}`,
                    dtstart,
                    dtend,
                    `SUMMARY:${event.title}`,
                    `DESCRIPTION:${event.description.replace(/\n/g, '\\n')}`,
                    `LOCATION:${event.location || ''}`,
                    'END:VEVENT'
                ].join('\r\n') + '\r\n';
            });
            
            icsString += 'END:VCALENDAR';
            return icsString;
        }
    </script>

</body>
</html>
